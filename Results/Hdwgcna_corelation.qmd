---
title: "Single-cell Gene modules correlation with neuropathology markers"
---

```{r eval=FALSE}
A <-read.delim("/media/jaumatell/datos/URI/BAYESPRISM_12_3/CELL_PROP/FTLD/TDP/significatives_nonparametric_with_means_cs.tsv")



# Defineix el directori on tens els fitxers
directori <- "/media/jaumatell/datos/URI/BAYESPRISM_12_3/CORRELATION/EGG_VS_COV/FTLD/TDP/CS/TDP43"  

# Llista de fitxers (assumint que són .tsv o .csv, adapta segons calgui)
fitxers <- list.files(path = directori, pattern = "\\.txt$|\\.tsv$|\\.csv$", full.names = TRUE)

# Inicialitza una llista per guardar els resultats
resultats <- data.frame(
  fitxer = character(),
  pvalue_significatius = integer(),
  total_files = integer(),
  stringsAsFactors = FALSE
)

# Itera sobre cada fitxer
for (fitxer in fitxers) {
  # Llegeix el fitxer (ajusta el separador si cal)
  taula <- read.csv(fitxer, header = TRUE)
  
  # Compta les files amb p.value < 0.05
  significatius <- sum(taula$p.value < 0.05, na.rm = TRUE)
  
  # Compta el total de files
  total <- nrow(taula)
  
  # Afegeix a la taula de resultats
  resultats <- rbind(resultats, data.frame(
    fitxer = basename(fitxer),
    pvalue_significatius = significatius,
    total_files = total,
    stringsAsFactors = FALSE
  ))
}

# Mostra el resultat
print(resultats)
write.csv(resultats, file = "/media/jaumatell/datos/URI/BAYESPRISM_12_3/CORRELATION/EGG_VS_COV/FTLD/TDP/CS/resum_resultats_TDP43.csv", row.names = FALSE)



# Defineix el directori on hi ha les carpetes de cell states
directori_base <- "/media/jaumatell/datos/URI/BAYESPRISM_12_3/hdWGCNA/FTLD/TDP/CS"  # Canvia això per la teva ruta

# Llista de subcarpetes (cell states)
cell_states <- list.dirs(path = directori_base, recursive = FALSE, full.names = TRUE)

# Inicialitza la taula de resultats
resultats <- data.frame(
  cell_state = character(),
  pvalue_significatius = integer(),
  total_moduls = integer(),
  stringsAsFactors = FALSE
)

# Itera per cada carpeta de cell state
for (carpeta in cell_states) {
  fitxer <- file.path(carpeta, "MODULES/cor_summary.csv")
  
  if (file.exists(fitxer)) {
    # Llegeix l’arxiu
    taula <- read.csv(fitxer, header = TRUE)
    
    # Compta mòduls significatius
    significatius <- sum(taula$p.value < 0.05, na.rm = TRUE)
    
    # Compta mòduls totals
    total <- nrow(taula)
    
    # Nom del cell state (nom de la carpeta)
    cell_state_nom <- basename(carpeta)
    
    # Afegeix-ho a la taula de resultats
    resultats <- rbind(resultats, data.frame(
      cell_state = cell_state_nom,
      pvalue_significatius = significatius,
      total_moduls = total,
      stringsAsFactors = FALSE
    ))
  }
}

# Guarda el resultat en un CSV
write.csv(resultats, file = "/media/jaumatell/datos/URI/BAYESPRISM_12_3/hdWGCNA/FTLD/TDP/resum_correlacio_moduls_Healthy_vs_ctrl_CS.csv", row.names = FALSE)


# Defineix el directori base amb les carpetes de tipus cel·lular
directori_base <- "/media/jaumatell/datos/URI/BAYESPRISM_12_3/EDGER/NEW/CS"  # Substitueix amb la ruta correcta

# Llista de subcarpetes (tipus cel·lular)
carpetes <- list.dirs(path = directori_base, recursive = FALSE, full.names = TRUE)

# Inicialitza la taula de resultats
resultats <- data.frame(
  tipus_cellular = character(),
  n_positius = integer(),
  n_negatius = integer(),
  stringsAsFactors = FALSE
)

# Itera per cada carpeta
for (carpeta in carpetes) {
  fitxer <- file.path(carpeta, "FTLD/results_adj_h.csv")
  
  if (file.exists(fitxer)) {
    # Llegeix el fitxer
    taula <- read.csv(fitxer, header = TRUE)
    
    # Compta valors 1 i -1 en la columna "X1.FTLD..1.Control"
    positius <- sum(taula$X1.FTLD..1.Control == 1, na.rm = TRUE)
    negatius <- sum(taula$X1.FTLD..1.Control == -1, na.rm = TRUE)
    
    # Nom del tipus cel·lular (nom de la carpeta)
    nom_cell <- basename(carpeta)
    
    # Afegeix a la taula de resultats
    resultats <- rbind(resultats, data.frame(
      tipus_cellular = nom_cell,
      n_positius = positius,
      n_negatius = negatius,
      stringsAsFactors = FALSE
    ))
  }
}

# Guarda el resultat en un fitxer CSV
write.csv(resultats, file = "/media/jaumatell/datos/URI/BAYESPRISM_12_3/EDGER/NEW/CS/resum_resultats_up_down.csv", row.names = FALSE)


###### VOLCANOPLOTS
library(ggplot2)
library(EnhancedVolcano)
library(tidyverse)

results_dir <- "/media/jaumatell/datos/URI/BAYESPRISM_12_3/EDGER/FTLD/TDP/CS"
output_dir <- file.path(results_dir, "volcano_plots")
dir.create(output_dir, showWarnings = FALSE)

files <- list.files(results_dir, pattern = "results_adj_h\\.csv$", full.names = TRUE, recursive = TRUE)

for (file in files) {
  file_base <- basename(dirname(file))
  df <- tryCatch({
    read_csv(file, show_col_types = FALSE)
  }, error = function(e) {
    warning(paste("Error reading", file, ":", e$message))
    return(NULL)
  })
  if (is.null(df)) next
  colnames(df) <- c("Gene", "logFC", "logCPM", "LR", "PValue", "adj_pval", "TDP_vs_Healthy")
  required_cols <- c("logFC", "PValue", "adj_pval", "Gene")
  if (!all(required_cols %in% colnames(df))) {
    warning(paste("Skipping", file, "- missing required columns"))
    next
  }
  df$Gene <- as.character(df$Gene)
  p <- EnhancedVolcano(df,
                       lab = df$Gene,
                       x = 'logFC',
                       y = 'PValue',
                       title = paste("Volcano Plot -", file_base),
                       pCutoff = 0.05,
                       FCcutoff = 0,
                       pointSize = 2.5,
                       labSize = 3.5,
                       selectLab = df$Gene)
  ggsave(filename = file.path(output_dir, paste0(file_base, "_volcano.png")),
         plot = p, width = 8, height = 6, dpi = 300)
}
```

```{r correlation-modules-data, eval=FALSE}
correlation_modules <- load_or_placeholder(
  option_name = "results_vis.correlation_modules",
  pattern = "module.*correlation.*\\.(csv|tsv|txt|rds|rda|RData|xlsx)$",
  generator = function() {
    modules <- paste0("Module", seq_len(10))
    expand_grid(Source = modules, Target = modules) %>%
      mutate(Correlation = if_else(Source == Target, 1, runif(n(), min = -1, max = 1)))
  }
)
```

```{r correlation-modules-plot, eval=FALSE}
render_source_note(correlation_modules, "module correlations")
correlation_wide <- correlation_modules %>%
  tidyr::pivot_wider(names_from = Target, values_from = Correlation)
correlation_matrix <- correlation_wide %>%
  column_to_rownames("Source") %>%
  as.matrix()
correlation_hover <- correlation_modules %>%
  mutate(label = glue::glue("{Source} vs {Target}<br>Correlation: {round(Correlation, 2)}")) %>%
  tidyr::pivot_wider(names_from = Target, values_from = label) %>%
  column_to_rownames("Source") %>%
  as.matrix()
plot_ly(
  x = colnames(correlation_matrix),
  y = rownames(correlation_matrix),
  z = correlation_matrix,
  type = "heatmap",
  colors = "RdBu",
  reversescale = TRUE,
  text = correlation_hover,
  hoverinfo = "text"
) %>%
  layout(title = "Module-Module Correlation Matrix") %>%
  annotate_placeholder(correlation_modules)
```
